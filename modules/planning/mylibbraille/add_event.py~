#!/usr/bin/env python3.4
import brlapi
import time
import os
import re
import sqlite3
import datetime

def     inputb(txt):
    b = brlapi.Connection()
    b.enterTtyMode()
    r = 0
    key = ""
    i = len(txt)+1 
    tmp = 0
    while tmp != 65293:
        b.writeText(txt+key, i)
        tmp = b.readKey()
        if len(key) > 40:
            ts = key[41:]
            b.writeText(ts, i)
        if tmp <= 255:
            key += chr(tmp)
            i += 1
        elif tmp == 65288 and (len(key)) < i:
            key = key[:-1]
            i -= 1
            if len(key) == 0:
                b.writeText(txt+" ", i)
                key = ""
                if i == len(txt):
                    i = len(txt)+1
                elif i == 41:
                    return key
    return key

def     add_event():
    conn = sqlite3.connect('agenda.db')
    cursor = conn.cursor()
    date = inputb("AAAA-MM-JJ : ")
    time = inputb("HH:MM : ")
    note = inputb("note:")
    # insert to db : agenda -> planing
    cursor.execute("""
    INSERT INTO planing(id, note) VALUES( ?, ?)""", [date+' '+time+':00',note])
    b = brlapi.Connection()
    b.enterTtyMode()
    b.writeText("ajout réussie :)")
    b.readKey()
    return 0

def     consult_event():
    conn = sqlite3.connect('agenda.db')
    cursor = conn.cursor()
    info = cursor.execute("SELECT * FROM planing")
    infos = info.fetchall()
    print(len(infos))
    b = brlapi.Connection()
    b.enterTtyMode()
    b.writeText("date :"+' '+str(info[0]))
    b.readKey()
    return 0

def     reset_event():
    conn = sqlite3.connect('agenda.db')
    cursor = conn.cursor()
    cursor.execute("DELETE * FROM planing")
    conn.commit()
    conn.close()
    b = brlapi.Connection()
    b.enterTtyMode()
    b.writeText("Réinitialisation réussie :)")
    b.readKey()
    return 0
